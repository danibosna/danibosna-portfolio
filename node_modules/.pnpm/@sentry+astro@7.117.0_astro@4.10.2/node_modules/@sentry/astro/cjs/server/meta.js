const core = require('@sentry/core');
const utils = require('@sentry/utils');

/**
 * Extracts the tracing data from the current span or from the client's scope
 * (via transaction or propagation context) and renders the data to <meta> tags.
 *
 * This function creates two serialized <meta> tags:
 * - `<meta name="sentry-trace" content="..."/>`
 * - `<meta name="baggage" content="..."/>`
 *
 * TODO: Extract this later on and export it from the Core or Node SDK
 *
 * @param span the currently active span
 * @param client the SDK's client
 *
 * @returns an object with the two serialized <meta> tags
 */
function getTracingMetaTags(
  span,
  scope,
  client,
) {
  const { dsc, sampled, traceId } = scope.getPropagationContext();
  const rootSpan = span && core.getRootSpan(span);

  const sentryTrace = span ? core.spanToTraceHeader(span) : utils.generateSentryTraceHeader(traceId, undefined, sampled);

  const dynamicSamplingContext = rootSpan
    ? core.getDynamicSamplingContextFromSpan(rootSpan)
    : dsc
      ? dsc
      : client
        ? core.getDynamicSamplingContextFromClient(traceId, client, scope)
        : undefined;

  const baggage = utils.dynamicSamplingContextToSentryBaggageHeader(dynamicSamplingContext);

  const isValidSentryTraceHeader = utils.TRACEPARENT_REGEXP.test(sentryTrace);
  if (!isValidSentryTraceHeader) {
    utils.logger.warn('Invalid sentry-trace data. Returning empty <meta name="sentry-trace"/> tag');
  }

  const validBaggage = isValidBaggageString(baggage);
  if (!validBaggage) {
    utils.logger.warn('Invalid baggage data. Returning empty <meta name="baggage"/> tag');
  }

  return {
    sentryTrace: `<meta name="sentry-trace" content="${isValidSentryTraceHeader ? sentryTrace : ''}"/>`,
    baggage: baggage && `<meta name="baggage" content="${validBaggage ? baggage : ''}"/>`,
  };
}

/**
 * Tests string against baggage spec as defined in:
 *
 * - W3C Baggage grammar: https://www.w3.org/TR/baggage/#definition
 * - RFC7230 token definition: https://datatracker.ietf.org/doc/html/rfc7230#section-3.2.6
 *
 * exported for testing
 */
function isValidBaggageString(baggage) {
  if (!baggage || !baggage.length) {
    return false;
  }
  const keyRegex = "[-!#$%&'*+.^_`|~A-Za-z0-9]+";
  const valueRegex = '[!#-+-./0-9:<=>?@A-Z\\[\\]a-z{-}]+';
  const spaces = '\\s*';
  // eslint-disable-next-line @sentry-internal/sdk/no-regexp-constructor -- RegExp for readability, no user input
  const baggageRegex = new RegExp(
    `^${keyRegex}${spaces}=${spaces}${valueRegex}(${spaces},${spaces}${keyRegex}${spaces}=${spaces}${valueRegex})*$`,
  );
  return baggageRegex.test(baggage);
}

exports.getTracingMetaTags = getTracingMetaTags;
exports.isValidBaggageString = isValidBaggageString;
//# sourceMappingURL=meta.js.map
